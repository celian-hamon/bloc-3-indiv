# Traefik Ingress Controller for Minikube
# Includes: CRDs-compatible IngressRoute, Deployment, RBAC, TLS
---
apiVersion: v1
kind: ServiceAccount
metadata:
    name: traefik
    namespace: collector

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
    name: traefik-role
rules:
    - apiGroups: [""]
      resources: ["services", "endpoints", "secrets"]
      verbs: ["get", "list", "watch"]
    - apiGroups: ["extensions", "networking.k8s.io"]
      resources: ["ingresses", "ingressclasses"]
      verbs: ["get", "list", "watch"]
    - apiGroups: ["extensions", "networking.k8s.io"]
      resources: ["ingresses/status"]
      verbs: ["update"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
    name: traefik-role-binding
roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: ClusterRole
    name: traefik-role
subjects:
    - kind: ServiceAccount
      name: traefik
      namespace: collector

---
apiVersion: apps/v1
kind: Deployment
metadata:
    name: traefik
    namespace: collector
    labels:
        app: traefik
spec:
    replicas: 1
    selector:
        matchLabels:
            app: traefik
    template:
        metadata:
            labels:
                app: traefik
        spec:
            serviceAccountName: traefik
            containers:
                - name: traefik
                  image: traefik:v3.0
                  args:
                      - "--api.insecure=true"
                      - "--ping=true"
                      - "--providers.kubernetesingress"
                      - "--providers.kubernetesingress.namespaces=collector"
                      - "--entrypoints.web.address=:80"
                      - "--entrypoints.websecure.address=:443"
                      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
                      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
                      - "--metrics.prometheus=true"
                      - "--metrics.prometheus.entrypoint=metrics"
                      - "--entrypoints.metrics.address=:8082"
                  ports:
                      - name: web
                        containerPort: 80
                      - name: websecure
                        containerPort: 443
                      - name: dashboard
                        containerPort: 8080
                      - name: metrics
                        containerPort: 8082
                  resources:
                      requests:
                          memory: "128Mi"
                          cpu: "100m"
                      limits:
                          memory: "512Mi"
                          cpu: "1000m"
                  readinessProbe:
                      httpGet:
                          path: /ping
                          port: 8080
                      initialDelaySeconds: 5
                      periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
    name: traefik
    namespace: collector
spec:
    type: NodePort
    selector:
        app: traefik
    ports:
        - name: web
          port: 80
          targetPort: 80
          nodePort: 30080
        - name: websecure
          port: 443
          targetPort: 443
          nodePort: 30443
        - name: dashboard
          port: 8080
          targetPort: 8080
          nodePort: 30088
        - name: metrics
          port: 8082
          targetPort: 8082
