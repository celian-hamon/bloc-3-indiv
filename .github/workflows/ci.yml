name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    # ──────────────────────────────────────────────
    # Stage 1 — Code quality (lint + format)
    # ──────────────────────────────────────────────
    quality:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install Ruff
              run: pip install ruff

            - name: Lint Backend
              working-directory: ./backend
              run: ruff check app/ tests/

            - name: Format check Backend
              working-directory: ./backend
              run: ruff format --check app/ tests/

            - name: Lint Chat Service
              working-directory: ./chat-service
              run: ruff check app/

            - name: Format check Chat Service
              working-directory: ./chat-service
              run: ruff format --check app/

    frontend-quality:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: frontend/package-lock.json

            - name: Install dependencies
              working-directory: ./frontend
              run: npm ci

            - name: Type Check (TypeScript)
              working-directory: ./frontend
              run: npm run build

            - name: Lint Rules (ESLint)
              working-directory: ./frontend
              run: npm run lint

    # ──────────────────────────────────────────────
    # Stage 2 — Security scan (DevSecOps)
    # ──────────────────────────────────────────────
    security:
        runs-on: ubuntu-latest
        needs: [quality, frontend-quality]
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: frontend/package-lock.json

            - name: Install backend dependencies
              working-directory: ./backend
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
                  pip install pip-audit

            - name: Install frontend dependencies
              working-directory: ./frontend
              run: npm ci

            - name: Install chat-service dependencies
              working-directory: ./chat-service
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
                  pip install pip-audit

            - name: Backend Security audit (pip-audit)
              working-directory: ./backend
              continue-on-error: true
              run: pip-audit -r requirements.txt --desc --output backend-audit-report.txt

            - name: Chat Service Security audit (pip-audit)
              working-directory: ./chat-service
              continue-on-error: true
              run: pip-audit -r requirements.txt --desc --output chat-audit-report.txt

            - name: Frontend Security audit (npm audit)
              working-directory: ./frontend
              continue-on-error: true
              run: npm audit > frontend-audit-report.txt || true

            - name: Upload audit reports
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: security-audit
                  path: |
                      backend/backend-audit-report.txt
                      chat-service/chat-audit-report.txt
                      frontend/frontend-audit-report.txt

    # ──────────────────────────────────────────────
    # Stage 3 — Tests (unit + integration)
    # ──────────────────────────────────────────────
    test:
        runs-on: ubuntu-latest
        needs: quality
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install dependencies
              working-directory: ./backend
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
              env:
                  SQLALCHEMY_DATABASE_URI: "sqlite+aiosqlite:///:memory:"

            - name: Run unit tests
              working-directory: ./backend
              run: pytest tests/test_fraud.py -v
              env:
                  SQLALCHEMY_DATABASE_URI: "sqlite+aiosqlite:///:memory:"

            - name: Run integration tests with coverage
              working-directory: ./backend
              run: pytest tests/ -v --cov=app --cov-report=term-missing --cov-report=xml
              env:
                  SQLALCHEMY_DATABASE_URI: "sqlite+aiosqlite:///:memory:"

            - name: Upload coverage report
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: backend/coverage.xml

    # ──────────────────────────────────────────────
    # Stage 4 — Docker build validation
    # ──────────────────────────────────────────────
    build:
        runs-on: ubuntu-latest
        needs: [security, test, frontend-quality]
        steps:
            - uses: actions/checkout@v4

            - name: Build Backend Docker image
              run: docker build -t collector-api:${{ github.sha }} ./backend

            - name: Verify Backend image
              run: docker image inspect collector-api:${{ github.sha }}

            - name: Build Chat Service Docker image
              run: docker build -t chat-service:${{ github.sha }} ./chat-service

            - name: Verify Chat Service image
              run: docker image inspect chat-service:${{ github.sha }}

            - name: Build Frontend Docker image
              run: docker build -t collector-frontend:${{ github.sha }} ./frontend

            - name: Verify Frontend image
              run: docker image inspect collector-frontend:${{ github.sha }}

    # ──────────────────────────────────────────────
    # Stage 5 — Update Manifests for Argo CD (GitOps)
    # ──────────────────────────────────────────────
    deploy:
        runs-on: ubuntu-latest
        needs: [build]
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        permissions:
            contents: write
        steps:
            - uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Set up Scaleway Container Registry Login
              uses: docker/login-action@v3
              with:
                  registry: rg.fr-par.scw.cloud
                  username: nologin
                  password: ${{ secrets.SCW_SECRET_KEY }}

            - name: Build and push Docker images
              run: |
                  API_IMAGE="rg.fr-par.scw.cloud/bloc-3-indiv/collector-api"
                  CHAT_IMAGE="rg.fr-par.scw.cloud/bloc-3-indiv/chat-service"
                  FRONT_IMAGE="rg.fr-par.scw.cloud/bloc-3-indiv/collector-frontend"

                  docker build -t $API_IMAGE:${{ github.sha }} -t $API_IMAGE:latest ./backend
                  docker push $API_IMAGE --all-tags

                  docker build -t $CHAT_IMAGE:${{ github.sha }} -t $CHAT_IMAGE:latest ./chat-service
                  docker push $CHAT_IMAGE --all-tags

                  docker build -t $FRONT_IMAGE:${{ github.sha }} -t $FRONT_IMAGE:latest ./frontend
                  docker push $FRONT_IMAGE --all-tags

            - name: Update Kubernetes manifests
              run: |
                  API_IMAGE="rg.fr-par.scw.cloud/bloc-3-indiv/collector-api"
                  CHAT_IMAGE="rg.fr-par.scw.cloud/bloc-3-indiv/chat-service"
                  FRONT_IMAGE="rg.fr-par.scw.cloud/bloc-3-indiv/collector-frontend"

                  # Update APIs manifest
                  sed -i "s|image: $API_IMAGE:.*|image: $API_IMAGE:${{ github.sha }}|g" k8s/app.yml
                  sed -i "s|image: collector-api:latest|image: $API_IMAGE:${{ github.sha }}|g" k8s/app.yml
                  sed -i "s|imagePullPolicy: Never|imagePullPolicy: Always|g" k8s/app.yml

                  # Update Chat Service manifest
                  sed -i "s|image: $CHAT_IMAGE:.*|image: $CHAT_IMAGE:${{ github.sha }}|g" k8s/chat.yml
                  sed -i "s|image: $CHAT_IMAGE:latest|image: $CHAT_IMAGE:${{ github.sha }}|g" k8s/chat.yml

                  # Update Frontend manifest
                  sed -i "s|image: $FRONT_IMAGE:.*|image: $FRONT_IMAGE:${{ github.sha }}|g" k8s/frontend.yml
                  sed -i "s|image: collector-frontend:latest|image: $FRONT_IMAGE:${{ github.sha }}|g" k8s/frontend.yml
                  sed -i "s|imagePullPolicy: Never|imagePullPolicy: Always|g" k8s/frontend.yml

            - name: Commit and push changes
              run: |
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"
                  git add k8s/app.yml k8s/frontend.yml k8s/chat.yml
                  # Commit and push if there are changes
                  git diff --quiet && git diff --staged --quiet || (git commit -m "chore: update images to ${{ github.sha }} for Argo CD" && git push)
