name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    # ──────────────────────────────────────────────
    # Stage 1 — Code quality (lint + format)
    # ──────────────────────────────────────────────
    quality:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install Ruff
              run: pip install ruff

            - name: Lint
              run: ruff check app/ tests/

            - name: Format check
              run: ruff format --check app/ tests/

    # ──────────────────────────────────────────────
    # Stage 2 — Security scan (DevSecOps)
    # ──────────────────────────────────────────────
    security:
        runs-on: ubuntu-latest
        needs: quality
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Security audit (pip-audit)
              continue-on-error: true
              run: pip-audit -r requirements.txt --desc --output audit-report.txt

            - name: Upload audit report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: security-audit
                  path: audit-report.txt

    # ──────────────────────────────────────────────
    # Stage 3 — Tests (unit + integration)
    # ──────────────────────────────────────────────
    test:
        runs-on: ubuntu-latest
        needs: quality
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
              env:
                  SQLALCHEMY_DATABASE_URI: "sqlite+aiosqlite:///:memory:"

            - name: Run unit tests
              run: pytest tests/test_fraud.py -v
              env:
                  SQLALCHEMY_DATABASE_URI: "sqlite+aiosqlite:///:memory:"

            - name: Run integration tests with coverage
              run: pytest tests/ -v --cov=app --cov-report=term-missing --cov-report=xml
              env:
                  SQLALCHEMY_DATABASE_URI: "sqlite+aiosqlite:///:memory:"

            - name: Upload coverage report
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: coverage.xml

    # ──────────────────────────────────────────────
    # Stage 4 — Docker build validation
    # ──────────────────────────────────────────────
    build:
        runs-on: ubuntu-latest
        needs: [security, test]
        steps:
            - uses: actions/checkout@v4

            - name: Build Docker image
              run: docker build -t collector-api:${{ github.sha }} .

            - name: Verify image
              run: docker image inspect collector-api:${{ github.sha }}

    # ──────────────────────────────────────────────
    # Stage 5 — Update Manifests for Argo CD (GitOps)
    # ──────────────────────────────────────────────
    deploy:
        runs-on: ubuntu-latest
        needs: [build]
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        permissions:
            contents: write
        steps:
            - uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Set up Scaleway Container Registry Login
              uses: docker/login-action@v3
              with:
                  registry: rg.fr-par.scw.cloud
                  username: nologin
                  password: ${{ secrets.SCW_SECRET_KEY }}

            - name: Build and push Docker image
              run: |
                  # NOTE: Make sure to replace 'my-namespace' with your actual SCW Container Registry namespace
                  IMAGE="rg.fr-par.scw.cloud/bloc-3-indiv/collector-api"
                  docker build -t $IMAGE:${{ github.sha }} -t $IMAGE:latest .
                  docker push $IMAGE --all-tags

            - name: Update Kubernetes manifests
              run: |
                  IMAGE="rg.fr-par.scw.cloud/bloc-3-indiv/collector-api"
                  # Update image in manifests dynamically to use the freshly built image
                  sed -i "s|image: collector-api:latest|image: $IMAGE:${{ github.sha }}|g" k8s/app.yml
                  # Remove 'imagePullPolicy: Never' so Kapsule will pull the image from the registry
                  sed -i "s|imagePullPolicy: Never|imagePullPolicy: Always|g" k8s/app.yml

            - name: Commit and push changes
              run: |
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"
                  git add k8s/app.yml
                  # Commit and push if there are changes
                  git diff --quiet && git diff --staged --quiet || (git commit -m "chore: update image to ${{ github.sha }} for Argo CD" && git push)
